" The VIMRC of Evan Pete Walsh >> epwalsh.com :: epwalsh10@gmail.com 
"
" 'I always thought air was free until I bought a bag of chips.'
" - Unknown
"
" Last Modified: Mon 29 Feb 2016 08:09:34 PM CST

" Vundle package manager -------------------------------------------------- {{{
set nocompatible             
filetype off                  

" Set the runtime path to include Vundle and initialize
set rtp+=~/.vim/bundle/Vundle.vim
call vundle#begin()

" Plugins
Bundle 'gmarik/Vundle.vim'
Bundle 'vim-scripts/Vim-R-plugin'
Bundle 'altercation/vim-colors-solarized'
Bundle 'Lokaltog/powerline', {'rtp': 'powerline/bindings/vim/'}
Bundle 'klen/python-mode'
Bundle 'davidhalter/jedi-vim'
Bundle 'jalvesaq/R-Vim-runtime'
Bundle 'scrooloose/nerdtree'
Bundle 'msanders/snipmate.vim'
Bundle 'ervandew/supertab'
Bundle 'vim-scripts/AutoComplPop'
Bundle 'mattn/emmet-vim'
"Bundle 'ivanov/vim-ipython'
Bundle 'jpalardy/vim-slime'
Bundle 'imouzon/iliketowatch'
Bundle 'scrooloose/nerdcommenter'

call vundle#end()
filetype plugin indent on
" ------------------------------------------------------------------------- }}}

" Basic settings ---------------------------------------------------------- {{{

" This will cause autocomplete tip window to close as soon as a selection is
" made. This is particular useful for pymode rope omnicompletion.
autocmd CompleteDone * pclose

" Leaders
let maplocalleader = ","
let mapleader = ","

" Make sure background works properly for tmux
set t_ut=

set mouse=a

" Make sure backspace works properly
set backspace=indent,eol,start

" Highlight during word search
set nohls

" Enable syntax highlighting
syntax enable

" Theme settings 
set background=dark
let g:solarized_termcolors = 256
colorscheme solarized

" Line numbers
set number 
set relativenumber

" Highlight text past 80 characters and add vertical bar
" Highlight Excess ctermbg=DarkGrey guibg=Black
" Match Excess /\%80v.*/
set colorcolumn=80

" Don't wrap lines by default
set nowrap 

" Toggle paste 
set pastetoggle=<F3>

" Popup menu behavior -------------------------------------------------- {{{
set completeopt=longest,menuone
inoremap <expr> <CR> pumvisible() ? "\<C-y>" : "\<C-g>u\<CR>"

inoremap <expr> <C-n> pumvisible() ? '<C-n>' :
  \ '<C-n><C-r>=pumvisible() ? "\<lt>Down>" : ""<CR>'

inoremap <expr> <M-,> pumvisible() ? '<C-n>' :
  \ '<C-x><C-o><C-n><C-p><C-r>=pumvisible() ? "\<lt>Down>" : ""<CR>'
" ---------------------------------------------------------------------- }}}

" Abbreviations
iabbrev @@ epwalsh10@gmail.com 
" ------------------------------------------------------------------------- }}}

" Mappings ---------------------------------------------------------------- {{{
nnoremap ; :
vnoremap ; :
"nmap : <nop>
"vmap : <nop>

" Always use very magic setting for regex searches
nmap / /\v
vmap / /\v

" Toggle relative line numbers 
nnoremap <F5> :setlocal relativenumber!<cr>
inoremap <F5> <esc>:setlocal relativenumber!<cr>li
vnoremap <F5> :<c-u>normal! `<mr`>mt<cr>:<c-u>setlocal relativenumber!
            \<cr>:<c-u>normal! `rv`t<cr>
nnoremap <leader><F5> :setlocal relativenumber!<cr>
vnoremap <leader><F5> :<c-u>normal! `<mr`>mt<cr>:<c-u>setlocal relativenumber!
            \<cr>:<c-u>normal! `rv`t<cr>

" Toggle line wrap 
nnoremap <F8> :setlocal wrap!<cr>
inoremap <F8> <esc>:setlocal wrap!<cr>li
vnoremap <F8> :<c-u>normal! `<mr`>mt<cr>:<c-u>setlocal wrap!
            \<cr>:<c-u>normal! `rv`t<cr>

" Jump to matching character (ex. matching brace or parenthesis)
nnoremap <leader>m %

" Execute :nohl with <F4>
nnoremap <F4> :set<Space>hls!<cr>
vnoremap <F4> :<c-u>normal! `<mr`>mt<cr>:<c-u>set<Space>hls!<cr>:<c-u>normal! `rv`t<cr>

" Movements between windows when not in tmux
nnoremap <c-j> <nop>
" map <c-j> <c-w>j
" map <c-k> <c-w>k
" map <c-l> <c-w>l
" map <c-h> <c-w>h

" Move lines up or down 
nnoremap ∆ :m .+1<CR>==
nnoremap ˚ :m .-2<CR>==
vnoremap ∆ :m '>+1<CR>gv=gv 
vnoremap ˚ :m '<-2<CR>gv=gv

" Change current word to uppercase 
inoremap <leader>u <esc>bveUea
nnoremap <leader>u bveUe 
" Change current word to lowercase
inoremap <leader>l <esc>bveuea
nnoremap <leader>l <esc>bveue

" Copy current line 
nnoremap <leader>yl 0v$y

" Global copying and pasting between files open in vim
" These mappings are not working for some reason
" vnoremap <F6> "+y
" nnoremap <F7> "+p
vmap <leader>cp "+y
nmap <leader>cv "+p
imap <leader>cv <esc>"+pi
" inoremap <F7> <esc>"+pi
" nnoremap <leader><F7> "+p

" Open vimrc in a split
nnoremap <leader>ev :vsplit $MYVIMRC<cr>
" Source vimrc 
nnoremap <leader>sv :source $MYVIMRC<cr> 

" Put quotes around a word
nnoremap <leader>" ea"<esc>hbi"<esc>lel
nnoremap <leader>' ea'<esc>hbi'<esc>lel 
vnoremap <leader>" <esc>`>a"<esc>`<i"<esc>`>ll
vnoremap <leader>' <esc>`>a'<esc>`<i'<esc>`>ll 

" Escape insert mode without having to press that stupid <esc> key
inoremap jk <esc>
vnoremap <leader>jk <esc>
" Map <esc> to no operation in insert mode
"inoremap <esc> <nop> 

" Quickly jump to beginning and end of lines
nnoremap H 0
nnoremap L $h
vnoremap H 0
vnoremap L $h

" Define some nifty operating-pending mappings
onoremap p i(
onoremap in( :<c-u>normal! f(vi(<cr>
onoremap il( :<c-u>normal! F)vi(<cr>

" Find trailing whitespace
nnoremap <leader>w mqgg/\v\s+$<cr>`q
" Remove trailing whitespace
nnoremap <leader>W mqgg:%s:\v\s+$:<cr>`q

" Insert line below and stay in normal mode
nnoremap <leader>o o<esc>
" Insert line above and stay in normal mode
nnoremap <leader>O O<esc>

" Git 
nnoremap <leader>gc :! git commit -a -m 'updates'<cr>
nnoremap <leader>gp :! git push<cr>
" ------------------------------------------------------------------------- }}}

" Powerline setup --------------------------------------------------------- {{{
set guifont=DejaVu\ Sans\ Mono\ for\ Powerline\ 11
set laststatus=2
let g:Powerline_symbols = 'fancy'
" ------------------------------------------------------------------------- }}}

" Nerdtree ---------------------------------------------------------------- {{{
" Activate nerdtree with F2
map <F2> :NERDTreeToggle<CR>
" ------------------------------------------------------------------------- }}}

" FileType-specific settings ---------------------------------------------- {{{

" Vimscript file settings ---------------------------------------------- {{{
augroup filetype_vim
    autocmd!
    au FileType vim setlocal shiftwidth=4 tabstop=4 expandtab
    " Allow code folding (type 'za' to fold or unfold)
    au FileType vim setlocal foldmethod=marker
    au Bufwritepre,filewritepre *.vimrc execute "normal ma"
    au Bufwritepre,filewritepre *.vimrc execute "1," . 10 . 
                \"g/Last Modified:.*/s/Last Modified:.*/Last Modified: " 
                \.strftime("%c")
    au bufwritepost,filewritepost *.vimrc execute "normal `a"
augroup END
" ---------------------------------------------------------------------- }}}

" R settings ----------------------------------------------------------- {{{
" Disable annoying shortcut for R
let vimrplugin_assign = 0

autocmd FileType R call SetROptions()
if !exists("*SetROptions")
    function SetROptions() 
        vmap <buffer> <Space> <Plug>RDSendSelection
        nmap <buffer> <Space> <Plug>RDSendLine
        "nmap <buffer> <LocalLeader>cc <Plug>RToggleComment
        "vmap <buffer> <LocalLeader>cc <Plug>RToggleComment
        map <buffer> <LocalLeader>nr :call RAction("rownames")<CR>
        map <buffer> <LocalLeader>nc :call RAction("colnames")<CR>
        map <buffer> <LocalLeader>nn :call RAction("names")<CR>
        map <buffer> <LocalLeader>nD :call RAction("dimnames")<CR>
        map <buffer> <LocalLeader>nd :call RAction("dim")<CR>
        map <buffer> <LocalLeader>nh :call RAction("head")<CR>
        map <buffer> <LocalLeader>nt :call RAction("tail")<CR>
        map <buffer> <LocalLeader>nl :call RAction("length")<CR>
        map <buffer> <LocalLeader>ns :call RAction("str")<CR>
        map <buffer> <LocalLeader>nC :call RAction("class")<CR>
        map <buffer> <LocalLeader>na :call RAction("args")<CR>
        map <buffer> <LocalLeader>nw :call SendCmdToR("system('clear')")<CR>
        map <buffer> <LocalLeader>ne :call SendCmdToR("system('traceback()')")<CR>
        map <buffer> <LocalLeader>sb :call SendCmdToR("system.time({")<CR>
        map <buffer> <LocalLeader>se :call SendCmdToR("})")<CR>
        map <buffer> <LocalLeader>tt :call SendCmdToR("tt = ")<CR>
        map <buffer> <LocalLeader>rm :call SendCmdToR("rm(list=ls())")<CR>
        map <buffer> <LocalLeader>ls :call SendCmdToR("ls()")<CR>
        map <buffer> <LocalLeader>qy :call SendCmdToR("q(save = 'yes')")<CR>
        map <buffer> <LocalLeader>qn :call SendCmdToR("q(save = 'no')")<CR>
        setlocal shiftwidth=2 tabstop=2 expandtab
    endfunction
endif

" See VIM-R-Plugin manual for details on these
let vimrplugin_applescript=0
let vimrplugin_vsplit=1

" Custom header for R files 
augroup R_header 
    autocmd!
    au BufNewFile *.R 0r ~/.vim/headers/R_header.txt
    au BufNewFile *.R execute "1," . 10 . "g/File Name:.*/s//File Name:     " 
                \.expand("%:t")
    au BufNewFile *.R execute "1," . 10 . 
                \"g/Creation Date:.*/s//Creation Date: " 
                \.strftime("%d-%m-%Y")
    au Bufwritepre,filewritepre *.R execute "normal ma"
    au Bufwritepre,filewritepre *.R execute "1," . 10 . 
                \"g/Last Modified:.*/s/Last Modified:.*/Last Modified: " 
                \.strftime("%c")
    au bufwritepost,filewritepost *.R execute "normal `a"
augroup END

" Add support for Python 
" runtime r-plugin/global_r_plugin.vim
" ---------------------------------------------------------------------- }}}

" Latex settings ------------------------------------------------------- {{{
augroup tex_settings
    autocmd!
    au BufRead *.tex set tw=150
    au Filetype tex set tw=150
    au FileType tex setlocal colorcolumn=150
    au FileType tex setlocal shiftwidth=2 tabstop=2 expandtab 
    au FileType tex nnoremap <leader>kk :!open %:r.pdf -a /Applications/Skim.app/<cr>
    au FileType tex nnoremap <leader>lu :!lualatex %:t<cr>
augroup END

set grepprg=grep\ -nH\ $*
let g:tex_flavor='latex'

" Insert favorite preamble
augroup tex_header
    autocmd!
    au BufNewFile *.tex 0r ~/.vim/headers/tex_header.txt
augroup END
" ---------------------------------------------------------------------- }}}

" C/Cpp settings --------------------------------------------------------- {{{
" Custom header for c/cpp files 
augroup cpp_header
    autocmd!
    au BufNewFile *.c 0r ~/.vim/headers/cpp_header.txt
    au BufNewFile *.c exe "1," . 10 . "g/File Name:.*/s//File Name:     " 
                \.expand("%:t")
    au BufNewFile *.c exe "1," . 10 . 
                \"g/Creation Date:.*/s//Creation Date: " 
                \.strftime("%d-%m-%Y")
    au Bufwritepre,filewritepre *.c execute "normal ma"
    au Bufwritepre,filewritepre *.c execute "1," . 10 . 
                \"g/Last Modified:.*/s/Last Modified:.*/Last Modified: " 
                \.strftime("%c")
    au bufwritepost,filewritepost *.c execute "normal `a"
    au BufNewFile *.cpp 0r ~/.vim/headers/cpp_header.txt
    au BufNewFile *.cpp exe "1," . 10 . "g/File Name:.*/s//File Name:     " 
                \.expand("%:t")
    au BufNewFile *.cpp exe "1," . 10 . 
                \"g/Creation Date:.*/s//Creation Date: " 
                \.strftime("%d-%m-%Y")
    au Bufwritepre,filewritepre *.cpp execute "normal ma"
    au Bufwritepre,filewritepre *.cpp execute "1," . 10 . 
                \"g/Last Modified:.*/s/Last Modified:.*/Last Modified: " 
                \.strftime("%c")
    au bufwritepost,filewritepost *.cpp execute "normal `a"
augroup END

augroup cpp_settings
    autocmd!
    au FileType c setlocal shiftwidth=4 tabstop=4 expandtab
    au FileType cpp setlocal shiftwidth=4 tabstop=4 expandtab
    au BufRead *.h setlocal shiftwidth=4 tabstop=4 expandtab
    au BufRead *.hpp setlocal shiftwidth=4 tabstop=4 expandtab
augroup END

" Custom header for cpp header files
augroup cpp_header_header
    autocmd!
    au BufNewFile *.h 0r ~/.vim/headers/cpp_header.txt
    au BufNewFile *.h exe "1," . 10 . "g/File Name:.*/s//File Name:     " 
                \.expand("%:t")
    au BufNewFile *.h exe "1," . 10 . 
                \"g/Creation Date:.*/s//Creation Date: " 
                \.strftime("%d-%m-%Y")
    au Bufwritepre,filewritepre *.h execute "normal ma"
    au Bufwritepre,filewritepre *.h execute "1," . 10 . 
                \"g/Last Modified:.*/s/Last Modified:.*/Last Modified: " 
                \.strftime("%c")
    au bufwritepost,filewritepost *.h execute "normal `a"
    au BufNewFile *.hpp 0r ~/.vim/headers/cpp_header.txt
    au BufNewFile *.hpp exe "1," . 10 . "g/File Name:.*/s//File Name: " 
                \.expand("%:t")
    au BufNewFile *.hpp exe "1," . 10 . 
                \"g/Creation Date:.*/s//Creation Date: " 
                \.strftime("%d-%m-%Y")
    au Bufwritepre,filewritepre *.hpp execute "normal ma"
    au Bufwritepre,filewritepre *.hpp execute "1," . 10 . 
                \"g/Last Modified:.*/s/Last Modified:.*/Last Modified: " 
                \.strftime("%c")
    au bufwritepost,filewritepost *.hpp execute "normal `a"
augroup END

" Ensure tabs are used for makefile 
augroup make_settings
    autocmd!
    au FileType make setlocal noexpandtab shiftwidth=8 softtabstop=0
augroup END
" ---------------------------------------------------------------------- }}}

" Python settings ------------------------------------------------------ {{{
" Syntax highlighting
let g:pymode_syntax = 1
let g:pymode_syntax_all = 1
let g:pymode_syntax_indent_errors = g:pymode_syntax_all
let g:pymode_syntax_space_errors = g:pymode_syntax_all
let g:pymode_folding = 0 " Don't autofold code
let g:SuperTabDefaultCompletionType = "context"
let g:pymode_virtualenv = 1
let g:pymode_rope = 0
set completeopt=menuone,longest,preview
au FileType python setlocal shiftwidth=4 tabstop=4 expandtab
au FileType python setlocal omnifunc=pythoncomplete#Complete

" Custom header 
augroup python_header
    autocmd!
    au BufNewFile *.py 0r ~/.vim/headers/py_header.txt
    au BufNewFile *.py exe "1," . 10 . "g/File Name:.*/s//File Name:     " 
                \.expand("%:t")
    au BufNewFile *.py exe "1," . 10 . 
                \"g/Creation Date:.*/s//Creation Date: " 
                \.strftime("%d-%m-%Y")
    au Bufwritepre,filewritepre *.py execute "normal ma"
    au Bufwritepre,filewritepre *.py execute "1," . 10 . 
                \"g/Last Modified:.*/s/Last Modified:.*/Last Modified: " 
                \.strftime("%c")
    au bufwritepost,filewritepost *.py execute "normal `a"
augroup END

" Use slime to send python code to interpreter.
autocmd FileType python call SetPythonOptions()
if !exists("*SetPythonOptions")
    function SetPythonOptions()
        " Using ipython within tmux is the best way.
        let g:slime_target = "tmux"
        " Create a tempory file to hold sent commands 
        let g:slime_paste_file = tempname()
        let g:slime_default_config = {"socket_name": "default", "target_pane": "1"}
        " Enable ipython's magic paste
        let g:slime_python_ipython = 1
        vmap <buffer> <leader><Space> <Plug>SlimeRegionSend
        nmap <buffer> <leader><Space> <Plug>SlimeLineSend
        " After sending code to ipython, move to the next line with code, not
        " comments.
        vmap <buffer> <Space> <Plug>SlimeRegionSend'>:set<Space>nois<cr>:set<Space>nohls<cr>/^[^#]+$<cr>:set<Space>is<cr>
        nmap <buffer> <Space> <Plug>SlimeLineSend:set<Space>nois<cr>:set<Space>nohls<cr>/^[^#]+$<cr>:set<Space>is<cr>
    endfunction
endif
" ---------------------------------------------------------------------- }}}

" HTML/CSS settings ---------------------------------------------------- {{{
let g:user_emmet_leader_key='<C-Z>'
augroup html_settings
    autocmd!
    au FileType html setlocal shiftwidth=2 tabstop=2 expandtab
    au FileType html setlocal nowrap
    au FileType css setlocal shiftwidth=4 tabstop=4 expandtab 
    au FileType css setlocal nowrap 
augroup END
" ---------------------------------------------------------------------- }}}

" Bash settings -------------------------------------------------------- {{{
augroup bash_settings
    autocmd!
    au FileType sh setlocal shiftwidth=4 tabstop=4 expandtab
    au BufNewFile *.sh 0r ~/.vim/headers/sh_header.txt 
augroup END
" ---------------------------------------------------------------------- }}}
" ------------------------------------------------------------------------- }}}

" Comments ---------------------------------------------------------------- {{{
let NERDSpaceDelims = 1
"function! CppCommentBlock(comment)
"    let start = '/*'
"    let finish = '*/'
"    " Build the comment box and put the comment inside it...
"    return start . "\<CR>"
"    \    . a:comment . "\<CR>"
"    \    . "\<BS>\<BS>" . finish . "\<CR>"
"endfunction
"
"nnoremap cc <nop>
"vnoremap cc <nop>
"augroup comments
"    autocmd!
"    au FileType python nnoremap <buffer> <localleader>cc 
"                \mqI# <esc>`qll
"    au FileType python vnoremap <buffer> <localleader>cc 
"                \<esc>mq:'<,'>s:^:# :<cr>:nohlsearch<cr>`qll
"    au FileType python nnoremap <buffer> <localleader>cu 
"                \mq:s:#\s\\|#<cr>:nohlsearch<cr>`qhh
"    au FileType python vnoremap <buffer> <localleader>cu 
"                \<esc>mq:'<,'>s:#\s\\|#::<cr>:nohlsearch<cr>`qhh
"    au FileType cpp nnoremap <buffer> <localleader>cc 
"                \mqI// <esc>`qlll
"    au FileType cpp vnoremap <buffer> <localleader>cc 
"                \<esc>mq`>A */<esc>`<I/* <esc>`q
"    au FileType cpp inoremap <buffer> <localleader>// 
"                \<c-r>=CppCommentBlock(input("Enter comment: "))<cr>
"    au FileType html nnoremap <buffer> <localleader>cc 
"                \mqI<!-- <esc>A--><esc>`q5l
"    au FileType html vnoremap <buffer> <localleader>cc 
"                \<esc>mq`>A --><esc>`<I<!-- <esc>`q
"augroup END
" ------------------------------------------------------------------------- }}}
